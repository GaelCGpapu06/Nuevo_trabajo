<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
    <style>
        #map { height: 500px; }
        .button-container { margin: 10px; }
    </style>
</head>
<body>
    <div class="button-container">
        <button onclick="buscarClinicas()">Marcadores</button>
        <button onclick="limpiarMarcadores()">Limpiar</button>
        <button onclick="calcularRuta()">Calcular Ruta</button>
        <p id="distancia"></p>
    </div>
    <div id="map"></div>
    <script>
        let map = L.map('map').setView([-12.0464, -77.0428], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let origenMarker;
        let destinoMarker;
        let markers = [];
        let routingControl;

        map.on('click', function(e) {
            if (origenMarker) map.removeLayer(origenMarker);
            origenMarker = L.marker(e.latlng, { icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            })}).addTo(map).bindPopup("Origen").openPopup();
        });

        function buscarClinicas() {
            let query = `[out:json];node["amenity"="clinic"](around:5000,-12.0464,-77.0428);out;`;
            let url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];

                    data.elements.forEach(element => {
                        let marker = L.marker([element.lat, element.lon], { icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34]
                        })}).addTo(map).bindPopup(element.tags.name || "Clínica");
                        markers.push(marker);
                    });
                });
        }

        function limpiarMarcadores() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            if (routingControl) map.removeControl(routingControl);
            document.getElementById("distancia").innerText = "";
        }

        function calcularRuta() {
            if (!origenMarker || markers.length === 0) {
                alert("Seleccione un origen y busque clínicas.");
                return;
            }
            
            let origen = origenMarker.getLatLng();
            let distancias = markers.map(marker => {
                let destino = marker.getLatLng();
                let distancia = map.distance(origen, destino);
                return { marker, distancia, latlng: destino };
            });
            
            distancias.sort((a, b) => a.distancia - b.distancia);
            let clinicaCercana = distancias[0];
            
            if (destinoMarker) map.removeLayer(destinoMarker);
            destinoMarker = L.marker(clinicaCercana.latlng, { icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            })}).addTo(map).bindPopup("Destino").openPopup();
            
            let osrmUrl = `https://router.project-osrm.org/route/v1/car/${origen.lng},${origen.lat};${clinicaCercana.latlng.lng},${clinicaCercana.latlng.lat}?overview=full&geometries=geojson`;
            
            fetch(osrmUrl)
                .then(response => response.json())
                .then(data => {
                    let route = data.routes[0];
                    let distanciaKm = (route.distance / 1000).toFixed(2);
                    document.getElementById("distancia").innerText = `Distancia: ${distanciaKm} km`;
                    
                    if (routingControl) map.removeControl(routingControl);
                    routingControl = L.polyline(route.geometry.coordinates.map(coord => [coord[1], coord[0]]), {
                        color: 'blue',
                        weight: 5
                    }).addTo(map);
                });
        }
    </script>
</body>
</html>
